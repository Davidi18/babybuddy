{% extends 'babybuddy/page.html' %}
{% load i18n widget_tweaks babybuddy %}
{% block title %}
    {% trans "User Settings" %}
{% endblock %}
{% block breadcrumbs %}
    <li class="breadcrumb-item">{% trans "User" %}</li>
    <li class="breadcrumb-item active">{% trans "Settings" %}</li>
{% endblock %}
{% block content %}
    <h1>{% trans "User Settings" %}</h1>
    <div class="container-fluid">
        <form role="form" method="post">
            {% csrf_token %}
            {% if form.non_field_errors %}
                {% for error in form.non_field_errors %}
                    <div class="alert alert-danger" role="alert">
                        <strong>{% trans "Error" %}</strong>: {{ error }}
                    </div>
                {% endfor %}
            {% elif form.errors %}
                <div class="alert alert-danger" role="alert">
                    <strong>{% trans "Error" %}</strong>: {% trans "Some fields have errors. See below for details." %}
                </div>
            {% endif %}
            <fieldset>
                <legend>{% trans "User Profile" %}</legend>
                <div class="form-group row">
                    {% with form_user.first_name as field %}
                        {% include 'babybuddy/form_field.html' %}
                    {% endwith %}
                </div>
                <div class="form-group row">
                    {% with form_user.last_name as field %}
                        {% include 'babybuddy/form_field.html' %}
                    {% endwith %}
                </div>
                <div class="form-group row">
                    {% with form_user.email as field %}
                        {% include 'babybuddy/form_field.html' %}
                    {% endwith %}
                </div>
                <div class="form-group row">
                    {% with form_settings.language as field %}
                        {% include 'babybuddy/form_field.html' %}
                    {% endwith %}
                </div>
                <div class="form-group row">
                    {% with form_settings.timezone as field %}
                        {% include 'babybuddy/form_field.html' %}
                    {% endwith %}
                </div>
                <div class="form-group row">
                    {% with form_settings.pagination_count as field %}
                        {% include 'babybuddy/form_field.html' %}
                    {% endwith %}
                </div>
            </fieldset>
            <fieldset>
                <legend>{% trans "Dashboard" %}</legend>
                <div class="form-group row">
                    {% with form_settings.dashboard_refresh_rate as field %}
                        {% include 'babybuddy/form_field.html' %}
                    {% endwith %}
                </div>
                <div class="form-group row">
                    {% with form_settings.dashboard_hide_empty as field %}
                        {% include 'babybuddy/form_field.html' %}
                    {% endwith %}
                </div>
                <div class="form-group row">
                    {% with form_settings.dashboard_hide_age as field %}
                        {% include 'babybuddy/form_field.html' %}
                    {% endwith %}
                </div>
            </fieldset>
            <fieldset>
                <legend>{% trans "API" %}</legend>
                <div class="form-group row">
                    <label class="col-sm-2 col-form-label">{% trans "Key" %}</label>
                    <div class="col-sm-10">
                        <div class="d-flex flex-column flex-sm-row align-items-start gap-2">
                            <samp class="flex-grow-1 align-self-center">{{ user.settings.api_key }}</samp>
                            <input type="submit"
                                   name="api_key_regenerate"
                                   value="{% trans "Regenerate" %}"
                                   class="btn btn-danger btn-sm" />
                        </div>
                    </div>
                </div>
            </fieldset>
            <input type="hidden" name="next" value="{% url 'babybuddy:user-settings' %}" />
            <div class="mt-3">
                <input type="submit"
                       name="save_settings"
                       value="{% trans "Submit" %}"
                       class="btn btn-primary">
            </div>
        </form>
        <hr />
        <fieldset>
            <legend>{% trans "Push Notifications" %}</legend>
            <div id="push-notifications-section">
                <div id="push-not-supported" style="display:none;">
                    <div class="alert alert-warning">
                        {% trans "Push notifications are not supported in this browser. On iOS, you must add this site to your Home Screen from Safari first." %}
                    </div>
                </div>
                <div id="push-not-configured" style="display:none;">
                    <div class="alert alert-info">
                        {% trans "Push notifications are not configured on the server. Ask your administrator to set VAPID keys." %}
                    </div>
                </div>
                <div id="push-controls" style="display:none;">
                    <div class="form-group row">
                        <label class="col-sm-2 col-form-label">{% trans "Status" %}</label>
                        <div class="col-sm-10">
                            <div class="d-flex flex-column flex-sm-row align-items-start gap-2">
                                <span id="push-status" class="align-self-center"></span>
                                <button type="button" id="push-enable-btn" class="btn btn-success btn-sm" style="display:none;">
                                    {% trans "Enable Notifications" %}
                                </button>
                                <button type="button" id="push-disable-btn" class="btn btn-warning btn-sm" style="display:none;">
                                    {% trans "Disable Notifications" %}
                                </button>
                                <button type="button" id="push-test-btn" class="btn btn-info btn-sm" style="display:none;">
                                    {% trans "Send Test" %}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </fieldset>
    </div>
{% endblock %}
{% block javascript %}
<script>
(function() {
    var csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    var notSupported = document.getElementById('push-not-supported');
    var notConfigured = document.getElementById('push-not-configured');
    var controls = document.getElementById('push-controls');
    var statusEl = document.getElementById('push-status');
    var enableBtn = document.getElementById('push-enable-btn');
    var disableBtn = document.getElementById('push-disable-btn');
    var testBtn = document.getElementById('push-test-btn');

    if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
        notSupported.style.display = 'block';
        return;
    }

    // Fetch VAPID public key
    fetch('{% url "babybuddy:push-vapid-key" %}')
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (!data.vapid_public_key) {
                notConfigured.style.display = 'block';
                return;
            }
            controls.style.display = 'block';
            initPush(data.vapid_public_key);
        })
        .catch(function() {
            notConfigured.style.display = 'block';
        });

    function urlBase64ToUint8Array(base64String) {
        var padding = '='.repeat((4 - base64String.length % 4) % 4);
        var base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
        var rawData = window.atob(base64);
        var outputArray = new Uint8Array(rawData.length);
        for (var i = 0; i < rawData.length; ++i) {
            outputArray[i] = rawData.charCodeAt(i);
        }
        return outputArray;
    }

    function updateUI(subscribed) {
        if (subscribed) {
            statusEl.textContent = '{% trans "Enabled" %}';
            statusEl.className = 'align-self-center badge bg-success';
            enableBtn.style.display = 'none';
            disableBtn.style.display = '';
            testBtn.style.display = '';
        } else {
            statusEl.textContent = '{% trans "Disabled" %}';
            statusEl.className = 'align-self-center badge bg-secondary';
            enableBtn.style.display = '';
            disableBtn.style.display = 'none';
            testBtn.style.display = 'none';
        }
    }

    function initPush(vapidKey) {
        navigator.serviceWorker.ready.then(function(reg) {
            reg.pushManager.getSubscription().then(function(sub) {
                updateUI(!!sub);
            });
        });

        enableBtn.addEventListener('click', function() {
            enableBtn.disabled = true;
            enableBtn.textContent = '...';
            Notification.requestPermission().then(function(permission) {
                if (permission !== 'granted') {
                    enableBtn.disabled = false;
                    enableBtn.textContent = '{% trans "Enable Notifications" %}';
                    alert('{% trans "Notification permission was denied." %}');
                    return;
                }
                navigator.serviceWorker.ready.then(function(reg) {
                    reg.pushManager.subscribe({
                        userVisibleOnly: true,
                        applicationServerKey: urlBase64ToUint8Array(vapidKey)
                    }).then(function(sub) {
                        var subJson = sub.toJSON();
                        return fetch('{% url "babybuddy:push-subscribe" %}', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': csrfToken
                            },
                            body: JSON.stringify({
                                endpoint: subJson.endpoint,
                                keys: subJson.keys
                            })
                        });
                    }).then(function(resp) {
                        return resp.json();
                    }).then(function() {
                        updateUI(true);
                        enableBtn.disabled = false;
                        enableBtn.textContent = '{% trans "Enable Notifications" %}';
                    }).catch(function(err) {
                        console.error('Push subscription error:', err);
                        enableBtn.disabled = false;
                        enableBtn.textContent = '{% trans "Enable Notifications" %}';
                    });
                });
            });
        });

        disableBtn.addEventListener('click', function() {
            disableBtn.disabled = true;
            navigator.serviceWorker.ready.then(function(reg) {
                reg.pushManager.getSubscription().then(function(sub) {
                    if (!sub) {
                        updateUI(false);
                        return;
                    }
                    var endpoint = sub.endpoint;
                    sub.unsubscribe().then(function() {
                        return fetch('{% url "babybuddy:push-unsubscribe" %}', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': csrfToken
                            },
                            body: JSON.stringify({ endpoint: endpoint })
                        });
                    }).then(function() {
                        updateUI(false);
                        disableBtn.disabled = false;
                    });
                });
            });
        });

        testBtn.addEventListener('click', function() {
            testBtn.disabled = true;
            testBtn.textContent = '...';
            fetch('{% url "babybuddy:push-test" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                }
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                testBtn.disabled = false;
                testBtn.textContent = '{% trans "Send Test" %}';
                if (data.devices > 0) {
                    alert('{% trans "Test notification sent!" %}');
                } else {
                    alert('{% trans "No subscribed devices found." %}');
                }
            })
            .catch(function() {
                testBtn.disabled = false;
                testBtn.textContent = '{% trans "Send Test" %}';
            });
        });
    }
})();
</script>
{% endblock %}
